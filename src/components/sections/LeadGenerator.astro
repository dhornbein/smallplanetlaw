---
import CurvedEdge from "../ui/CurvedEdge.astro";
import BookCover from "../ui/BookCover.astro";
import portraitShadow from "../../assets/hero-shadow-wide.jpg";
import portraitShadowTall from "../../assets/hero-shadow-tall.jpg";
import coverGreenEP from "../../assets/cover-green-ep-guide.jpg";
import cover6Mistakes from "../../assets/cover-6-mistakes-guide.jpg";
import { LEAD_MAGNETS } from "../../utils/global";

// Map cover images by lead magnet ID
const coverImages: Record<string, ImageMetadata> = {
  "green-ep-guide": coverGreenEP,
  "6-mistakes-guide": cover6Mistakes,
};
---

<section class="relative pb-40 bg-neutral-warm">
  <lead-generator class="block">
    {LEAD_MAGNETS.map((magnet, index) => (
      <div
        class="lead-variant hidden"
        data-variant={magnet.id}
        data-tag={magnet.tag}
      >
        <!-- Hero image with overlaid title -->
        <div
          class="relative shadow-lg mb-8 bg-var min-h-[50vh] bg-cover bg-center"
          style={`--bg-img: url(${portraitShadowTall.src}); --bg-img-md: url(${portraitShadow.src});`}
        >
          <div class="absolute inset-0 bg-outer-space-900/60 flex items-center justify-center">
            <div class="flex flex-col md:flex-row items-center gap-8 md:gap-12 px-4 sm:px-6 max-w-4xl">
              {coverImages[magnet.id] && (
                <a href="#free" class="shrink-0 -mb-4 md:mb-0">
                  <BookCover
                    src={coverImages[magnet.id]}
                    alt={`${magnet.title} cover`}
                    size="md"
                  />
                </a>
              )}
              <div class="text-center md:text-left text-white">
                <p class="text-sm font-semibold uppercase tracking-wider text-olivine-300 mb-3">
                  Free Download
                </p>
                <h2 class="text-3xl sm:text-4xl lg:text-5xl font-serif font-bold text-white mb-0">
                  {magnet.title}
                </h2>
              </div>
            </div>
          </div>
        </div>

        <!-- Teaser, bullets & form -->
        <div id="free" class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 text-center scroll-m-24">
          <p class="text-xl text-text-secondary mb-8 leading-relaxed max-w-2xl mx-auto">
            {magnet.teaser}
          </p>

          <ul class="lead-bullets text-left max-w-md mx-auto mb-10 space-y-3">
            {magnet.bullets.map((bullet) => (
              <li class="flex items-start gap-3 text-text-secondary">
                <svg class="shrink-0 w-5 h-5 text-primary mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span>{bullet}</span>
              </li>
            ))}
          </ul>

          <!-- Form -->
          <form class="lead-form max-w-md mx-auto" method="POST" action="/api/newsletter">
            <input type="hidden" name="tags" value={magnet.tag} />
            <div class="space-y-3">
              <div>
                <label for={`lead-email-${index}`} class="sr-only">Email address</label>
                <input
                  type="email"
                  id={`lead-email-${index}`}
                  name="email"
                  required
                  class="w-full px-4 py-3 rounded-md border border-neutral text-text-primary placeholder-outer-space-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="you@example.com"
                />
              </div>
              <div>
                <label for={`lead-name-${index}`} class="sr-only">First name</label>
                <input
                  type="text"
                  id={`lead-name-${index}`}
                  name="firstName"
                  class="w-full px-4 py-3 rounded-md border border-neutral text-text-primary placeholder-outer-space-300 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent"
                  placeholder="First name (optional)"
                />
              </div>
              <button
                type="submit"
                class="w-full px-8 py-4 bg-accent hover:bg-accent-variant text-white font-medium text-lg rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <span class="submit-text">{magnet.buttonText}</span>
                <span class="loading-text hidden">Sending...</span>
              </button>
            </div>

            <!-- Success message -->
            <div class="success-message mt-6 p-6 rounded-lg bg-hunter-green-100 border border-hunter-green-400 text-text-primary hidden" role="alert">
              <div class="flex items-center gap-3 mb-3">
                <svg class="w-8 h-8 text-primary shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p class="font-serif font-bold text-lg">Check your inbox!</p>
              </div>
              <p class="text-sm text-text-secondary">
                Your free guide is on its way. Please check your email â€” you may need to confirm your subscription first.
              </p>
            </div>

            <!-- Error message -->
            <div class="error-message mt-4 p-4 rounded-md bg-redwood-100 border border-redwood-400 text-text-primary hidden" role="alert">
              <p class="error-text"></p>
            </div>

            <p class="text-xs text-text-secondary text-center mt-4">
              We respect your privacy. Unsubscribe anytime.
            </p>
          </form>
        </div>
      </div>
    ))}
  </lead-generator>

  <CurvedEdge fillColor="fill-neutral-warm" position="bottom" />
</section>

<script>
  class LeadGeneratorElement extends HTMLElement {
    connectedCallback() {
      // A/B test: randomly pick a variant (50/50)
      const variants = this.querySelectorAll('.lead-variant');
      if (variants.length === 0) return;

      const chosenIndex = Math.random() < 0.5 ? 0 : 1;
      const chosen = variants[chosenIndex] || variants[0];
      chosen.classList.remove('hidden');

      // Set up form submission
      const form = chosen.querySelector('.lead-form') as HTMLFormElement | null;
      const successDiv = chosen.querySelector('.success-message');
      const errorDiv = chosen.querySelector('.error-message');
      const errorText = chosen.querySelector('.error-text');
      const submitButton = chosen.querySelector('button[type="submit"]') as HTMLButtonElement | null;
      const submitText = chosen.querySelector('.submit-text');
      const loadingText = chosen.querySelector('.loading-text');

      if (!form) return;

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Reset messages
        successDiv?.classList.add('hidden');
        errorDiv?.classList.add('hidden');
        if (errorText) errorText.textContent = '';

        // Show loading state
        if (submitButton) {
          submitButton.disabled = true;
          submitText?.classList.add('hidden');
          loadingText?.classList.remove('hidden');
        }

        try {
          const formData = new FormData(form);
          const response = await fetch('/api/newsletter', {
            method: 'POST',
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            // Show success
            successDiv?.classList.remove('hidden');
          } else {
            if (errorText) errorText.textContent = data.message;
            errorDiv?.classList.remove('hidden');
          }
        } catch (error) {
          if (errorText) errorText.textContent = 'Something went wrong. Please try again later.';
          errorDiv?.classList.remove('hidden');
        } finally {
          if (submitButton) {
            submitButton.disabled = false;
            submitText?.classList.remove('hidden');
            loadingText?.classList.add('hidden');
          }
        }
      });
    }
  }

  customElements.define('lead-generator', LeadGeneratorElement);
</script>
