---
import Button from "../ui/Button.astro";
import heroImg from "../../assets/hero-space.jpg";
import heroImgTall from "../../assets/hero-space-tall.jpg";
import { MAILCHIMP } from "../../utils/global";
---

<section
  class="relative py-20 bg-dark text-light bg-var bg-cover bg-center min-h-[40vh]"
  style={`--bg-img: url(${heroImgTall.src}); --bg-img-md: url(${heroImg.src});`}
>
  <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center mb-8">
      <h2>Stay Connected</h2>
      <p class="text-lg text-gray-300">
        Get estate planning tips, green living insights, and updates from Small
        Planet Law.
      </p>
    </div>

    <!-- Wrap the form in a custom element for reactive behavior -->
    <newsletter-form class="max-w-md mx-auto">
      <form method="POST" action="/api/newsletter">
        <div class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-medium mb-2">
              Email address *
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="w-full px-4 py-3 rounded-md bg-white/30 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent"
              placeholder="you@example.com"
            />
          </div>

          <div>
            <label for="firstName" class="block text-sm font-medium mb-2">
              First name (optional)
            </label>
            <input
              type="text"
              id="firstName"
              name="firstName"
              class="w-full px-4 py-3 rounded-md bg-white/30 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:ring-2 focus:ring-secondary focus:border-transparent"
              placeholder="Your first name"
            />
          </div>

          <button 
            type="submit"
            class="w-full px-6 py-3 bg-secondary hover:bg-secondary/90 text-dark font-medium rounded-md transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-secondary focus:ring-offset-2 focus:ring-offset-dark disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <span class="submit-text">Sign Up</span>
            <span class="loading-text hidden">Sending...</span>
          </button>
        </div>

        <!-- Success message -->
        <div 
          class="success-message mt-4 p-4 rounded-md bg-green-500/20 border border-green-500 text-green-100 hidden"
          role="alert"
        >
          <p class="font-medium mb-2">You have been successfully added to our newsletter!</p>
          <p class="text-sm mb-3">Please check your email to confirm your subscription.</p>
          <a 
            href={MAILCHIMP.archiveUrl}
            target="_blank" 
            rel="noopener noreferrer"
            class="text-sm text-green-200 hover:text-green-100 underline inline-block mb-3"
          >
            View our past newsletter archive â†’
          </a>
          <button 
            type="button"
            class="reset-form-button block w-full sm:w-auto px-4 py-2 bg-green-600/40 hover:bg-green-600/60 text-green-100 text-sm font-medium rounded transition-colors duration-200"
          >
            Add another email
          </button>
        </div>

        <!-- Error message -->
        <div 
          class="error-message mt-4 p-4 rounded-md bg-red-500/20 border border-red-500 text-red-100 hidden"
          role="alert"
        >
          <p class="error-text"></p>
        </div>

        <p class="text-sm text-gray-400 text-center mt-4">
          We respect your privacy. Unsubscribe anytime.
        </p>
      </form>
    </newsletter-form>
  </div>
</section>

<script>
  // Define behavior for our newsletter form custom element
  class NewsletterForm extends HTMLElement {
    connectedCallback() {
      // Get elements within this custom element instance
      const form = this.querySelector('form');
      const successDiv = this.querySelector('.success-message');
      const errorDiv = this.querySelector('.error-message');
      const errorText = this.querySelector('.error-text');
      const submitButton = this.querySelector('button[type="submit"]') as HTMLButtonElement | null;
      const submitText = this.querySelector('.submit-text');
      const loadingText = this.querySelector('.loading-text');
      const resetButton = this.querySelector('.reset-form-button');

      if (!form) return;

      // Handle reset button click
      resetButton?.addEventListener('click', () => {
        successDiv?.classList.add('hidden');
        form.reset();
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        // Reset messages
        successDiv?.classList.add('hidden');
        errorDiv?.classList.add('hidden');
        if (errorText) errorText.textContent = '';

        // Show loading state
        if (submitButton) {
          submitButton.disabled = true;
          submitText?.classList.add('hidden');
          loadingText?.classList.remove('hidden');
        }

        try {
          const formData = new FormData(form);
          const response = await fetch('/api/newsletter', {
            method: 'POST',
            body: formData,
          });

          const data = await response.json();

          if (data.success) {
            // Show success
            successDiv?.classList.remove('hidden');
            form.reset();
          } else {
            // Show error
            if (errorText) errorText.textContent = data.message;
            errorDiv?.classList.remove('hidden');
          }
        } catch (error) {
          // Network error
          if (errorText) errorText.textContent = 'Something went wrong. Please try again later.';
          errorDiv?.classList.remove('hidden');
        } finally {
          // Reset button state
          if (submitButton) {
            submitButton.disabled = false;
            submitText?.classList.remove('hidden');
            loadingText?.classList.add('hidden');
          }
        }
      });
    }
  }

  // Register the custom element
  customElements.define('newsletter-form', NewsletterForm);
</script>
