---
import Button from "../ui/Button.astro";
import LogoMark from "../ui/LogoMark.astro";
import { navItems, callToAction } from "../../utils/navigation";

// element that will trigger the sticky header when scrolled past
const { triggerSelector = ".show-header" } = Astro.props;

// Get the base path from Astro config (works in both dev and prod)
const base = import.meta.env.BASE_URL;

// Get the current path for active nav highlighting
const currentPath = new URL(Astro.request.url).pathname;

// Function to check if a nav item is active
const isActive = (href: string) => {
  // Convert relative href to absolute path using base
  let absoluteHref: string;
  
  if (href.startsWith('./')) {
    // Handle relative paths like "./" or "./about"
    const relativePath = href.substring(2); // Remove "./"
    absoluteHref = base + relativePath;
  } else if (href.startsWith('http')) {
    // External link, never active
    return false;
  } else {
    absoluteHref = href;
  }
  
  // Normalize paths for comparison (remove trailing slashes for comparison)
  const normalizedCurrent = currentPath.replace(/\/$/, '') || '/';
  const normalizedHref = absoluteHref.replace(/\/$/, '') || '/';
  
  // For home page (empty relative path becomes just the base)
  if (href === './' || href === '') {
    return normalizedCurrent === base.replace(/\/$/, '');
  }
  
  // Exact match for other pages
  return normalizedCurrent === normalizedHref;
};
---

<style>
  @reference "../../styles/global.css";

  header,
  header.is-top {
    @apply text-text-primary bg-transparent transition-colors duration-300;
    .logo .logo-circle,
    .logo .logo-path {
      fill: none;
      stroke: var(--color-text-primary);
    }
  }

  header.is-stuck {
    @apply bg-[#e9f1f3]/70 text-text-primary backdrop-blur-md shadow-lg;
    @apply z-50 fixed top-0 left-0 w-full transition-transform duration-300;
    animation: slideDown 0.3s ease-in-out;
    .logo .logo-circle,
    .logo .logo-path {
      fill: none;
      stroke: var(--color-text-primary);
    }
  }

  @keyframes slideDown {
    from {
      transform: translateY(-100%);
    }
    to {
      transform: translateY(0);
    }
  }

  header.mobile-menu-open {
    @apply text-white;
    .logo .logo-circle,
    .logo .logo-path {
      fill: none;
      stroke: white;
    }
  }

  #mobile-menu-button {
    @apply relative;
  }

  #mobile-menu-button .menu-icon {
    @apply transition-all duration-300;
  }

  #mobile-menu-button .menu-icon path {
    @apply transition-all duration-300 origin-center;
  }

  header.mobile-menu-open #mobile-menu-button .menu-icon {
    @apply text-white;
  }

  header.mobile-menu-open #mobile-menu-button .line-top {
    d: path("M4 12h16");
    transform: rotate(45deg);
  }

  header.mobile-menu-open #mobile-menu-button .line-middle {
    opacity: 0;
  }

  header.mobile-menu-open #mobile-menu-button .line-bottom {
    d: path("M4 12h16");
    transform: rotate(-45deg);
  }

  #mobile-menu {
    @apply transition-transform duration-300 ease-in-out;
    transform: translateX(100%);
    z-index: 100;
  }

  #mobile-menu.show {
    transform: translateX(0);
  }

  @media (min-width: 768px) {
    #mobile-menu {
      display: none !important;
    }
  }

  /* Desktop Navigation - Active indicator */
  nav a.nav-link {
    @apply relative;
  }

  nav a.nav-link::after {
    content: '';
    @apply absolute left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full;
    @apply bg-primary opacity-0 transition-opacity duration-200;
    bottom: -0.5rem;
  }

  nav a.nav-link:hover::after {
    @apply opacity-30;
  }

  nav a.nav-link.active::after {
    @apply opacity-100;
  }

  /* Mobile Navigation - Active indicator */
  #mobile-menu a.nav-link {
    @apply relative;
  }

  #mobile-menu a.nav-link::after {
    content: '';
    @apply absolute left-0 top-1/2 -translate-y-1/2 w-1.5 h-1.5 rounded-full;
    @apply bg-white opacity-0 transition-opacity duration-200;
    left: -1rem;
  }

  #mobile-menu a.nav-link:hover::after {
    @apply opacity-30;
  }

  #mobile-menu a.nav-link.active::after {
    @apply opacity-100;
  }
</style>

<header
  id="main-header"
  class="h-20 z-50 relative"
  data-trigger-selector={triggerSelector}
>
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 relative z-150">
    <div class="flex justify-between items-center py-4">
      <!-- Logo -->
      <a href="/" class="flex items-center space-x-3 group relative z-150">
        <LogoMark size="sm" class="logo" />
        <div class="flex flex-col">
          <span class="text-xl font-serif font-semibold">Small Planet Law</span>
          <span class="text-xs">Holistic Estate Planning</span>
        </div>
      </a>

      <!-- Desktop Navigation -->
      <nav class="hidden md:flex items-center space-x-8 z-50">
        {
          navItems.map((item) => (
            <a
              href={item.href}
              class:list={[
                "nav-link transition-colors duration-200 font-medium",
                { active: isActive(item.href) }
              ]}
            >
              {item.name}
            </a>
          ))
        }
        <Button href={callToAction.href} target={callToAction.target} size="sm">{callToAction.name}</Button>
      </nav>

      <!-- Mobile Menu Button -->
      <button
        id="mobile-menu-button"
        class="md:hidden p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-white/70 relative z-150"
        aria-label="Toggle menu"
        aria-expanded="false"
      >
        <svg
          class="w-6 h-6 menu-icon"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            class="line-top"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 6h16"></path>
          <path
            class="line-middle"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 12h16"></path>
          <path
            class="line-bottom"
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M4 18h16"></path>
        </svg>
      </button>
    </div>

    <!-- Mobile Navigation -->
    <nav
      id="mobile-menu"
      class="fixed top-0 left-0 w-full bg-stone-800 inset-shadow-lg pointer-events-none"
    >
      <div
        class="flex flex-col justify-around h-full min-h-dvh pt-24 pb-4 px-6"
      >
        {
          navItems.map((item) => (
            <a
              href={item.href}
              class:list={[
                "nav-link py-2 text-neutral-warm hover:text-white transition-colors duration-200 font-medium font-serif text-2xl",
                { active: isActive(item.href) }
              ]}
            >
              {item.name}
            </a>
          ))
        }
        <div class="pt-2">
          <Button href={callToAction.href} target={callToAction.target} size="lg" class="w-full">{callToAction.name}</Button>
        </div>
      </div>
    </nav>
  </div>
</header>

<script>
  // Get elements
  const mobileMenuButton = document.getElementById("mobile-menu-button");
  const mobileMenu = document.getElementById("mobile-menu");
  const header = document.getElementById("main-header");

  // Mobile menu toggle
  mobileMenuButton?.addEventListener("click", () => {
    const isOpen = mobileMenu?.classList.contains("show");
    
    if (isOpen) {
      mobileMenu?.classList.remove("show");
      header?.classList.remove("mobile-menu-open");
      // Re-enable scrolling
      document.body.style.overflow = "";
      // Re-disable pointer events after animation
      setTimeout(() => {
        mobileMenu?.classList.add("pointer-events-none");
      }, 300);
    } else {
      mobileMenu?.classList.remove("pointer-events-none");
      mobileMenu?.classList.add("show");
      header?.classList.add("mobile-menu-open");
      // Disable scrolling
      document.body.style.overflow = "hidden";
    }
    
    // Update aria-expanded for accessibility
    mobileMenuButton?.setAttribute("aria-expanded", isOpen ? "false" : "true");
  });

  // Track when we're at the top of the viewport
  const checkScrollPosition = () => {
    if (window.scrollY === 0) {
      header?.classList.add("is-top");
      header?.classList.remove("is-stuck");
    } else {
      header?.classList.remove("is-top");
    }
  };

  // Check on scroll
  window.addEventListener("scroll", checkScrollPosition);

  // Check on page load
  checkScrollPosition();

  // Sticky header on scroll past trigger element
  const triggerSelector = header?.dataset.triggerSelector;

  if (header && triggerSelector) {
    const triggerElement = document.querySelector(triggerSelector);

    if (triggerElement) {
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (!entry.isIntersecting) {
              // Trigger element has passed - make header sticky
              header.classList.add("is-stuck");
            }
          });
        },
        {
          threshold: 0,
          rootMargin: "0px",
        },
      );

      observer.observe(triggerElement);
    }
  }
</script>
